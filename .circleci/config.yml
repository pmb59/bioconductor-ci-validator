version: 2.1

commands:
  define_version:
    description: Define env var VERSION based on an optional git tag or the git branch name
    steps:
      - run:
          name: Define VERSION environment varrables
          command: |
            CIRCLE_BRANCH_CLEAN=$(echo ${CIRCLE_BRANCH} | sed "s;/;-;ig")

            if [ -n "${CIRCLE_TAG}" ]; then VERSION=${CIRCLE_TAG}; else VERSION="${CIRCLE_BRANCH_CLEAN}@${CIRCLE_SHA1:0:6}"; fi

            echo "export VERSION=$VERSION" >> $BASH_ENV

  print_version:
    description: Print the current VERSION
    steps:
      - run:
          name: Print version
          command: |
            echo "VERSION: $VERSION"
            

jobs:
  print-version:
    docker:
      - image: circleci/python:3
    steps:
      - define_version
      - print_version
      
  build:
    working_directory: /bioconductor-ci-validator
    docker:
      - image: bioconductor/bioconductor_docker:devel
    steps:
      - checkout
      - run:
          name: check r installation
          command: R --version
      - run:
          name: build and check bioconductor packages
          no_output_timeout: 50m
          command: bash build.sh
